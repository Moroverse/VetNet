# Story 1.1: Patient Creation & Profile Management

## Status
Approved

## Story
**As a** veterinary practice staff member,  
**I want to** create and manage patient profiles with essential information,  
**So that** I can maintain accurate patient records for scheduling and medical care.

## Acceptance Criteria

1. **UI Layer**
   - Patient creation form with fields:
     - Name (required)
     - Species (required, dropdown)
     - Breed (required, filtered by species)
     - Date of birth (required, date picker)
     - Weight (optional, with units)
     - Owner information (required)
     - Medical ID (auto-generated)
     - Microchip number (optional)
     - Notes (optional, multiline)
   - Form validation with inline errors
   - Save/Cancel actions
   - Loading states during save
   - Success confirmation

2. **Domain Layer**
   - Pure Patient domain model in `Features/PatientManagement/Domain/Models/`:
     - No persistence or framework dependencies
     - Rich business logic methods (age calculation, validation)
     - Species-specific breed validation rules
     - Medical ID generation algorithm
   - Business rules enforcement:
     - Future birth dates not allowed
     - Weight within species ranges
     - Owner relationship validation
   - Repository interface in `Features/PatientManagement/Domain/Repositories/`:
     - `PatientRepository` protocol defining persistence operations
     - Domain-centric method signatures
     - Enables testing with mock implementations

3. **Infrastructure Layer** 
   - SwiftData PatientEntity in `Infrastructure/Persistence/Entities/`:
     - `@Model` macro with CloudKit synchronization
     - Compound uniqueness constraints via `@Attribute(.unique)`
     - Automatic timestamps and soft delete support
     - Optimized for storage and sync performance
   - Repository implementation in `Infrastructure/Repositories/`:
     - `SwiftDataPatientRepository` implementing domain protocol
     - Maps between domain models and SwiftData entities  
     - Handles all persistence and CloudKit concerns
   - Relationships:
     - Owner (many-to-one)
     - Appointments (one-to-many)  
     - Medical records (one-to-many)

4. **Infrastructure**
   - Complete iOS project setup:
     - Swift 6.2+ configuration
     - Factory DI container setup
     - SwiftUIRouting integration
     - Liquid Glass design system
   - Development environment:
     - Tuist configuration
     - Git repository setup
     - CI/CD pipeline foundation

5. **Testing Infrastructure**
   - Mock repository implementations for domain testing:
     - `MockPatientRepository` implementing `PatientRepository` protocol
     - In-memory storage for isolated domain logic testing
     - Configurable success/failure scenarios
   - Domain model unit tests:
     - Business rule validation (90%+ coverage)
     - Edge case handling
     - No persistence dependencies
   - Repository integration tests:
     - Entity-to-domain mapping validation
     - SwiftData constraint verification
     - CloudKit synchronization testing

6. **Sample Data**
   - Pre-populated database with 20+ patients:
     - Dogs: Labrador (Max, Bella), German Shepherd (Rex, Luna), Golden Retriever (Charlie, Daisy)
     - Cats: Persian (Whiskers, Mittens), Maine Coon (Oliver, Sophie), Siamese (Leo, Cleo)
     - Exotic: Rabbit (Bunny), Parrot (Polly), Bearded Dragon (Spike), Guinea Pig (Patches)
   - Varied owner demographics
   - Realistic medical histories
   - Different age ranges

7. **Testing**
   - Unit tests:
     - Patient validation logic
     - Age calculation accuracy
     - Medical ID uniqueness
   - Integration tests:
     - Data persistence verification
     - CloudKit sync simulation
   - UI tests:
     - Form completion flow
     - Validation error display
     - Success path verification

8. **Feature Flag**
   - `patient_management_v1` controls:
     - Feature visibility
     - Mock vs. real data toggle
     - Progressive rollout
     - A/B testing capability

## Tasks / Subtasks

- [x] **Task 1: Project Structure & Infrastructure Setup** (AC: 4)
  - [x] Create modular project structure using Tuist configuration [Source: architecture/01-modular-design.md#feature-module-structure]
  - [x] Set up Swift 6.2+ with proper concurrency settings (SWIFT_DEFAULT_ACTOR_ISOLATION: "MainActor") [Source: architecture/10-coding-standards.md#swift-concurrency-configuration]
  - [x] Configure FactoryKit dependency injection container [Source: architecture/swift-best-practices.md#factorykit-dependency-injection]
  - [x] Integrate SwiftUIRouting module from `Modules/SwiftUIRouting/` [Source: architecture/02-tech-stack.md#custom-dependencies]
  - [x] Set up Liquid Glass design system components [Source: architecture/02-tech-stack.md#design-system]

- [ ] **Task 2: Domain Layer Implementation** (AC: 2)
  - [ ] Create `Features/PatientManagement/Domain/Models/Patient.swift` with pure Swift domain model [Source: architecture/03-feature-modules.md#patient-records-module-components]
  - [ ] Implement age calculation using Swift's Measurement API [Source: architecture/swift-best-practices.md#measurement-and-unit-patterns]
  - [ ] Add species-specific breed validation business rules [Source: architecture/swift-best-practices.md#domain-specific-validators]
  - [ ] Create Medical ID generation algorithm in domain layer [Source: architecture/04-data-models.md#repository-pattern-implementation]
  - [ ] Define `PatientRepository` protocol in `Features/PatientManagement/Domain/Repositories/` [Source: architecture/01-modular-design.md#layer-responsibilities]

- [ ] **Task 3: Infrastructure Layer Implementation** (AC: 3)
  - [ ] Create `PatientEntity` SwiftData model in `Infrastructure/Persistence/Entities/` [Source: architecture/04-data-models.md#patient-entity]
  - [ ] Implement compound uniqueness constraints using @Attribute(.unique) [Source: architecture/04-data-models.md#compound-constraints]
  - [ ] Set up CloudKit synchronization with custom zones for HIPAA compliance [Source: architecture/04-data-models.md#cloudkit-integration]
  - [ ] Create `SwiftDataPatientRepository` in `Infrastructure/Repositories/` [Source: architecture/04-data-models.md#repository-pattern-implementation]
  - [ ] Implement entity-to-domain model mapping logic [Source: architecture/01-modular-design.md#infrastructure-layer-rules]

- [ ] **Task 4: QuickForm UI Implementation** (AC: 1)
  - [ ] Create `PatientFormViewModel` using QuickForm @PropertyEditor patterns [Source: architecture/02-tech-stack.md#quickform]
  - [ ] Implement reactive field relationships (species â†’ breed filtering) [Source: architecture/swift-best-practices.md#quickform-usage]
  - [ ] Add comprehensive form validation using ValidationRule protocol [Source: architecture/swift-best-practices.md#data-validation-with-quickform]
  - [ ] Create SwiftUI patient form with Liquid Glass styling [Source: architecture/05-components.md#liquid-glass-design-system]
  - [ ] Implement accessibility identifiers for all form components [Source: architecture/10-coding-standards.md#accessibility-integration-rule]

- [ ] **Task 5: Testing Infrastructure** (AC: 5, 7)
  - [ ] Create `MockPatientRepository` implementing domain repository protocol [Source: architecture/09-testing-strategy.md#mockable-service-testing]
  - [ ] Write unit tests for domain model business logic using Swift Testing framework [Source: architecture/09-testing-strategy.md#ios-26-testing-architecture]
  - [ ] Implement repository integration tests verifying SwiftData mapping [Source: architecture/09-testing-strategy.md#module-isolation-testing]
  - [ ] Add ViewInspector tests for UI components using accessibility identifiers [Source: architecture/09-testing-strategy.md#viewinspector-swiftui-testing]
  - [ ] Create performance tests for large dataset handling [Source: architecture/09-testing-strategy.md#performance-testing-strategy]

- [ ] **Task 6: Sample Data & Feature Flag Setup** (AC: 6, 8)
  - [ ] Generate realistic sample data for 20+ patients across species [Source: epic-1-patient-management.md#sample-data]
  - [ ] Implement feature flag `patient_management_v1` using iOS 26 Configuration framework [Source: architecture/02-tech-stack.md#configuration-management]
  - [ ] Create data seeding service for development and testing environments [Source: architecture/swift-best-practices.md#testing-with-factorykit]
  - [ ] Add toggle between mock and real data in development builds [Source: architecture/swift-best-practices.md#preview-support]

## Dev Notes

### Architecture Context
This story implements the foundational Patient Management module following VetNet's Clean Architecture with Domain-Driven Design principles. The implementation uses a three-layer architecture where:

- **Domain Layer** contains pure Swift business models with rich domain logic
- **Infrastructure Layer** provides shared SwiftData entities and repository implementations  
- **Presentation Layer** uses SwiftUI with @Observable view models and QuickForm integration

### Key Technical Details

**Modular Structure** [Source: architecture/01-modular-design.md]:
- Patient Management is implemented as a self-contained feature module in `Features/PatientManagement/`
- Infrastructure layer is shared at Application level, not within individual feature modules
- Module communication through DTOs and domain events only

**SwiftData Integration** [Source: architecture/04-data-models.md]:
- SwiftData entities located in centralized `Infrastructure/Persistence/Entities/`
- Repository pattern abstracts domain logic from persistence concerns
- Compound uniqueness constraints prevent data integrity issues
- CloudKit synchronization configured with custom zones for HIPAA compliance

**Swift 6.2+ Patterns** [Source: architecture/10-coding-standards.md]:
- Default MainActor isolation configured project-wide (SWIFT_DEFAULT_ACTOR_ISOLATION: "MainActor")
- Most UI classes implicitly MainActor-isolated, reducing @MainActor boilerplate
- Use `nonisolated` for background operations only
- Structured concurrency patterns with TaskGroup for parallel operations

**QuickForm Integration** [Source: architecture/02-tech-stack.md]:
- Macro-driven forms with @PropertyEditor for type-safe data binding
- Reactive field relationships (species selection filters breed options)
- Declarative validation rules with real-time feedback
- 70% reduction in form-related boilerplate code

**FactoryKit Dependency Injection** [Source: architecture/swift-best-practices.md]:
- Services registered with `.cached` scope for reuse within container lifecycle
- `@Injected` property wrappers with `@ObservationIgnored` in @Observable ViewModels
- Test container isolation using `.container` trait
- Mock service registration for testing and previews

**Liquid Glass UI** [Source: architecture/05-components.md]:
- Use GlassEffectContainer for multiple glass elements
- Group related effects within containers for performance
- glassEffectID for morphing animations between states
- iOS 26 glass effects exclusive to SwiftUI providing 40% GPU performance improvement

### File Structure and Naming

**Domain Models** [Source: architecture/10-coding-standards.md]:
- `Features/PatientManagement/Domain/Models/Patient.swift` - Pure domain model
- `Features/PatientManagement/Domain/Repositories/PatientRepository.swift` - Repository protocol

**Infrastructure Implementation**:
- `Infrastructure/Persistence/Entities/PatientEntity.swift` - SwiftData @Model entity
- `Infrastructure/Repositories/SwiftDataPatientRepository.swift` - Repository implementation

**Presentation Layer**:
- `Features/PatientManagement/Presentation/ViewModels/PatientFormViewModel.swift` - @Observable ViewModel
- `Features/PatientManagement/Presentation/Views/PatientFormView.swift` - SwiftUI form view

**Public Interface**:
- `Features/PatientManagement/Public/PatientDTO.swift` - Data transfer object
- `Features/PatientManagement/Public/PatientModuleInterface.swift` - Public protocol

### Validation and Business Rules [Source: architecture/swift-best-practices.md]:
- Species-specific weight ranges validated using custom ValidationRule implementations
- Date validation prevents future birth dates using MaxDateRule
- Name validation combines multiple rules: .notEmpty, .minLength(2), .maxLength(50)
- Medical ID generation ensures uniqueness across practice

### Performance Considerations [Source: architecture/04-data-models.md]:
- SwiftData queries optimized using #Predicate with proper indexing
- Lazy loading for relationships to prevent N+1 query problems
- Memory-efficient data structures with NSCache for frequently accessed data
- Metal Performance Shaders integration for complex algorithms

## Testing

### Testing Framework Setup [Source: architecture/09-testing-strategy.md]:
- **Swift Testing**: Modern framework with @Suite and @Test attributes for organized structure
- **Mockable**: Protocol-based service mocking with @Mockable macro for PatientRepository
- **ViewInspector**: SwiftUI component testing using accessibility identifiers

### Test File Locations and Standards:
- **Unit Tests**: `Tests/UnitTests/PatientManagementTests/` for domain logic testing
- **Integration Tests**: `Tests/IntegrationTests/` for repository and data flow testing  
- **SwiftUI Tests**: `Tests/SwiftUITests/` for UI component and accessibility testing
- **Performance Tests**: `Tests/PerformanceTests/` for scalability and memory usage validation

### Required Test Coverage:
- Domain model business logic: 90%+ coverage requirement
- Repository mapping: 100% coverage for entity-domain conversions
- Form validation: All validation rules and edge cases
- Accessibility: VoiceOver navigation and Dynamic Type support

### Accessibility Testing Requirements [Source: architecture/09-testing-strategy.md]:
- All form elements must have `accessibilityIdentifier` using format: "component_type_identifier"
- Descriptive `accessibilityLabel` for VoiceOver users
- Dynamic Type scaling verification across all supported sizes
- Keyboard navigation testing for form completion workflows

### Testing Patterns:
```swift
// Use accessibility identifiers for reliable component finding
let nameField = try formView.inspect().find(viewWithAccessibilityIdentifier: "patient_name_field")
let submitButton = try formView.inspect().find(viewWithAccessibilityIdentifier: "save_patient_button")

// Mock repository setup for isolated testing
@Suite(.container)
struct PatientDomainTests {
    @Test
    func testPatientValidation() async throws {
        Container.shared.patientRepository.register { 
            MockPatientRepository() 
        }
        // Test implementation
    }
}
```

### HIPAA Compliance Testing [Source: architecture/09-testing-strategy.md]:
- Data encryption verification for patient information
- Access control testing with role-based permissions
- Audit trail logging validation for all data modifications
- CloudKit sync security testing with encrypted data transmission

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-07-22 | 1.0 | Initial story creation with comprehensive TDD approach | Claude Code |

## Dev Agent Record
*This section will be populated by the development agent during implementation*

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References  
- Task 1 Build Success: Build completed without compilation errors
- SwiftFormat/SwiftLint: Applied code formatting and linting corrections

### Completion Notes List
- Task 1: Successfully created modular project structure with Clean Architecture patterns
- Infrastructure: FactoryKit DI container and SwiftUIRouting integration ready for future implementation
- Design System: Liquid Glass components implemented with iOS 26 glass effects
- All files compile and pass linting checks

### File List
#### Created Files:
- `App/Sources/Features/PatientManagement/Domain/Models/` (directory structure)
- `App/Sources/Features/PatientManagement/Domain/Repositories/` (directory structure)  
- `App/Sources/Features/PatientManagement/Presentation/ViewModels/` (directory structure)
- `App/Sources/Features/PatientManagement/Presentation/Views/` (directory structure)
- `App/Sources/Features/PatientManagement/Public/` (directory structure)
- `App/Sources/Infrastructure/Persistence/Entities/` (directory structure)
- `App/Sources/Infrastructure/Repositories/` (directory structure)
- `App/Sources/Infrastructure/Configuration/Container+VetNet.swift`
- `App/Sources/Infrastructure/Configuration/VetNetRouter.swift`
- `App/Sources/Core/DesignSystem/LiquidGlass.swift`
- Test directories: `App/Tests/UnitTests/PatientManagementTests/`, `App/Tests/IntegrationTests/`, `App/Tests/SwiftUITests/`, `App/Tests/PerformanceTests/`

## QA Results
*Results from QA Agent review of the completed story implementation*