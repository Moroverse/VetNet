# Story 1.1: Patient Creation & Profile Management

## Status
Approved

## Story
**As a** veterinary practice staff member,  
**I want to** create and manage patient profiles with essential information,  
**so that** I can maintain accurate patient records for scheduling and medical care.

## Acceptance Criteria

1. **UI Layer**
   - Patient creation form with fields:
     - Name (required)
     - Species (required, dropdown)
     - Breed (required, filtered by species)
     - Date of birth (required, date picker)
     - Weight (optional, with units)
     - Owner information (required)
     - Medical ID (auto-generated)
     - Microchip number (optional)
     - Notes (optional, multiline)
   - Form validation with inline errors
   - Save/Cancel actions
   - Loading states during save
   - Success confirmation

2. **Domain Layer**
   - Pure Patient domain model in `Features/PatientManagement/Domain/Models/`:
     - No persistence or framework dependencies
     - Rich business logic methods (age calculation, validation)
     - Species-specific breed validation rules
     - Medical ID generation algorithm
   - Business rules enforcement:
     - Future birth dates not allowed
     - Weight within species ranges
     - Owner relationship validation
   - Repository interface in `Features/PatientManagement/Domain/Repositories/`:
     - `PatientRepository` protocol defining persistence operations
     - Domain-centric method signatures
     - Enables testing with mock implementations

3. **Infrastructure Layer** 
   - SwiftData PatientEntity in `Infrastructure/Persistence/Entities/`:
     - `@Model` macro with CloudKit synchronization
     - Compound uniqueness constraints via `@Attribute(.unique)`
     - Automatic timestamps and soft delete support
     - Optimized for storage and sync performance
   - Repository implementation in `Infrastructure/Repositories/`:
     - `SwiftDataPatientRepository` implementing domain protocol
     - Maps between domain models and SwiftData entities  
     - Handles all persistence and CloudKit concerns
   - Relationships:
     - Owner (many-to-one)
     - Appointments (one-to-many)  
     - Medical records (one-to-many)

4. **Infrastructure**
   - Complete iOS project setup:
     - Swift 6.2+ configuration
     - Factory DI container setup
     - SwiftUIRouting integration
     - Liquid Glass design system
   - Development environment:
     - Tuist configuration
     - Git repository setup
     - CI/CD pipeline foundation

5. **Testing Infrastructure**
   - Mock repository implementations for domain testing:
     - `MockPatientRepository` implementing `PatientRepository` protocol
     - In-memory storage for isolated domain logic testing
     - Configurable success/failure scenarios
   - Domain model unit tests:
     - Business rule validation (90%+ coverage)
     - Edge case handling
     - No persistence dependencies
   - Repository integration tests:
     - Entity-to-domain mapping validation
     - SwiftData constraint verification
     - CloudKit synchronization testing

6. **Sample Data**
   - Pre-populated database with 20+ patients:
     - Dogs: Labrador (Max, Bella), German Shepherd (Rex, Luna), Golden Retriever (Charlie, Daisy)
     - Cats: Persian (Whiskers, Mittens), Maine Coon (Oliver, Sophie), Siamese (Leo, Cleo)
     - Exotic: Rabbit (Bunny), Parrot (Polly), Bearded Dragon (Spike), Guinea Pig (Patches)
   - Varied owner demographics
   - Realistic medical histories
   - Different age ranges

7. **Testing**
   - Unit tests:
     - Patient validation logic
     - Age calculation accuracy
     - Medical ID uniqueness
   - Integration tests:
     - Data persistence verification
     - CloudKit sync simulation
   - UI tests:
     - Form completion flow
     - Validation error display
     - Success path verification

8. **Feature Flag**
   - `patient_management_v1` controls:
     - Feature visibility
     - Mock vs. real data toggle
     - Progressive rollout
     - A/B testing capability

## Tasks / Subtasks

- [x] **Task 1: Set up Domain Layer** (AC: 2)
  - [x] Create `Features/PatientRecords/Domain/Models/Patient.swift` with pure business logic
  - [x] Implement `PatientId` value object with UUID generation
  - [x] Add `calculateAge()` method using Date calculations
  - [x] Create `Species` and `Breed` enums with validation rules
  - [x] Implement `MedicalRecord` value object
  - [x] Create `PatientValidator` with species-specific weight validation
  - [x] Define `PatientRepository` protocol in `Features/PatientRecords/Domain/Repositories/`

- [x] **Task 2: Create SwiftData Infrastructure** (AC: 3)
  - [x] Create `Infrastructure/Persistence/Entities/PatientEntity.swift` with `@Model` macro
  - [x] Add `@Attribute(.unique)` constraint for `patientID: UUID`
  - [x] Implement CloudKit-compatible properties with appropriate types
  - [x] Add `@Relationship` annotations for Owner (many-to-one) and Appointments (one-to-many)
  - [x] Create `SwiftDataPatientRepository` implementing `PatientRepository` protocol
  - [x] Implement entity-to-domain model mapping methods
  - [x] Add automatic timestamp management (`createdAt`, `updatedAt`)

- [x] **Task 3: Build QuickForm Patient Creation UI** (AC: 1)
  - [x] Create `PatientComponents` struct following QuickForm patterns
  - [x] Implement `PatientFormViewModel` with `@QuickForm` annotation
  - [x] Add form fields using `@PropertyEditor` for each patient property
  - [x] Create `PatientFormView that is swiftUI Form
  - [x] Implement species-dependent breed filtering logic
  - [x] Add form validation with inline error display
  - [x] Include accessibility identifiers: `patient_name_field`, `species_picker`, `save_patient_button`
  - [x] Implement save/cancel actions with loading states

- [x] **Task 4: Set up Dependency Injection and Services** (AC: 4)
  - [x] Configure FactoryKit container for `PatientRepository` injection
  - [x] Register `SwiftDataPatientRepository` as implementation
  - [x] Create `PatientService` protocol and implementation
  - [x] Set up SwiftUIRouting integration for form navigation
  - [x] Configure feature flag `patient_management_v1` handling

- [x] **Task 5: Create Sample Data** (AC: 6)
  - [x] Create `SampleDataProvider` class with 20+ realistic patient records
  - [x] Include variety: Dogs (Labrador, German Shepherd, Golden Retriever), Cats (Persian, Maine Coon, Siamese), Exotics
  - [x] Generate varied owner demographics and medical histories
  - [x] Implement data loading on app launch with feature flag control

- [ ] **Task 6: Implement Testing Infrastructure** (AC: 5, 7)
  - [ ] Create `MockPatientRepository` implementing `PatientRepository` protocol
  - [ ] Write domain model unit tests in `PatientRecordsTests/Domain/`
  - [ ] Test patient validation logic with edge cases (future birth dates, invalid weights)
  - [ ] Add SwiftData integration tests for entity mapping and CloudKit sync
  - [ ] Create UI tests using ViewInspector with accessibility identifiers
  - [ ] Test form completion flow and validation error display
  - [ ] Achieve 90%+ test coverage for domain logic

## Dev Notes

### Architecture Context
This story implements the foundational patient management system following the established VetNet modular architecture patterns. All technical details are extracted from the project's architecture documentation.

### Domain Model Implementation
**Location**: `Features/PatientRecords/Domain/Models/Patient.swift`
- Pure Swift domain model with no persistence dependencies
- Business logic methods: `calculateAge()`, `isVaccinationDue()`, `getSpeciesSpecificProtocols()`
- Value objects for `PatientId`, `Species`, `Breed`, `MedicalRecord`, `Owner`
[Source: docs/architecture/04-data-models.md#domain-models]

### SwiftData Entity Design
**Location**: `Infrastructure/Persistence/Entities/PatientEntity.swift`
- `@Model` class with CloudKit synchronization support
- `@Attribute(.unique)` for `patientID: UUID` to prevent duplicates
- Relationships: `@Relationship(inverse: \Owner.patients) var owner: Owner?`
- Computed properties for age calculation and business logic
[Source: docs/architecture/04-data-models.md#swiftdata-entities]

### QuickForm Integration Pattern
**Location**: `Features/PatientRecords/Presentation/Views/PatientFormView.swift`
- `PatientComponents` struct separate from domain model
- `@QuickForm(PatientComponents.self)` view model with `@PropertyEditor` fields
- Reactive field relationships: species selection updates breed options and weight validation
- State management with `FormState` enum: idle, editing, saving, saved, error, validationError
[Source: docs/architecture/quickform-patterns.mdc]

### Repository Pattern Implementation
**Domain Protocol**: `Features/PatientRecords/Domain/Repositories/PatientRepository.swift`
```swift
protocol PatientRepository {
    func save(_ patient: Patient) async throws
    func findById(_ id: PatientId) async throws -> Patient?
    func findByName(_ name: String) async throws -> [Patient]
    func delete(_ patient: Patient) async throws
}
```

**SwiftData Implementation**: `Infrastructure/Repositories/SwiftDataPatientRepository.swift`
- Maps between domain models and SwiftData entities
- Handles CloudKit synchronization concerns
- Uses `#Predicate` for type-safe queries
[Source: docs/architecture/03-feature-modules.md#repository-pattern]

### Validation Rules
**Location**: `Features/PatientRecords/Domain/Validation/PatientValidator.swift`
- Species-specific weight ranges (dogs: 0.5-100kg, cats: 0.5-15kg)
- Name validation: 2-50 characters, letters/whitespace/hyphens only
- Birth date validation: no future dates, max 30 years ago
- Centralized `PatientValidator` class implementing `Sendable` for concurrency
[Source: docs/architecture/04-data-models.md#validation-rules]

### UI Component Specifications
**Accessibility Requirements**:
- All form fields must include `accessibilityIdentifier` for testing
- Format: snake_case (`patient_name_field`, `species_picker`, `save_patient_button`)
- `accessibilityLabel` for VoiceOver descriptions
- Dynamic Type support for accessibility
[Source: docs/architecture/10-coding-standards.md#accessibility]

### File Structure and Naming Conventions
```
Features/PatientRecords/
├── Domain/
│   ├── Models/Patient.swift
│   ├── Repositories/PatientRepository.swift
│   └── Validation/PatientValidator.swift
├── Application/
│   └── UseCases/CreatePatientUseCase.swift
├── Infrastructure/
│   ├── Repositories/SwiftDataPatientRepository.swift
│   └── Services/DefaultPatientService.swift
├── Presentation/
│   ├── Views/PatientFormView.swift
│   └── ViewModels/PatientFormViewModel.swift
└── Public/
    ├── DTOs/PatientDTO.swift
    └── PatientRecordsModuleInterface.swift
```
[Source: docs/architecture/03-feature-modules.md#modular-structure]

### Dependency Injection Configuration
- FactoryKit container registration for `PatientRepository`
- Service layer protocols: `PatientService`, `MedicalHistoryService`
- Mock implementations for testing: `MockPatientRepository`
[Source: docs/architecture/swift-best-practices.md#dependency-injection]

### Feature Flag Integration
- `patient_management_v1` controls feature visibility
- Toggle between mock and real data during development
- Progressive rollout capability for production
[Source: docs/architecture/03-feature-modules.md#feature-flags]

## Testing

### Testing Framework and Standards
**Framework**: Swift Testing with `@Suite` and `@Test` attributes
**UI Testing**: ViewInspector for SwiftUI component testing
**Mocking**: Mockable protocol for service layer testing
[Source: docs/architecture/09-testing-strategy.md]

### Test File Locations and Structure
```
PatientRecordsTests/
├── Domain/
│   ├── PatientTests.swift
│   ├── PatientValidatorTests.swift
│   └── MockPatientRepositoryTests.swift
├── Infrastructure/
│   └── SwiftDataPatientRepositoryTests.swift
├── Presentation/
│   └── PatientFormViewTests.swift
└── Integration/
    └── PatientCreationFlowTests.swift
```

### Required Test Coverage
- **Domain Models**: 90%+ coverage for business logic and validation rules
- **Repository Layer**: Entity mapping, CloudKit sync, constraint testing
- **UI Components**: Form validation, accessibility, user workflows
- **Integration**: End-to-end patient creation flow with real SwiftData stack
[Source: docs/architecture/09-testing-strategy.md#coverage-requirements]

### UI Testing Patterns
```swift
@Test("Patient form accessibility testing")
func testPatientFormAccessibility() throws {
    let form = PatientFormView()
    
    let nameField = try form.inspect().find(
        viewWithAccessibilityIdentifier: "patient_name_field"
    )
    let saveButton = try form.inspect().find(
        viewWithAccessibilityIdentifier: "save_patient_button"
    )
    
    #expect(nameField != nil, "Name field should have accessibility identifier")
    #expect(!try saveButton.button().isEnabled(), "Save button should be disabled initially")
}
```
[Source: docs/architecture/09-testing-strategy.md#ui-testing-patterns]

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-01-22 | 1.0 | Initial story creation from Epic 1.1 | Bob (Scrum Master) |

## Dev Agent Record

*This section will be populated by the development agent during implementation*

### Agent Model Used
claude-opus-4-20250514

### Debug Log References
*To be filled by dev agent*

### Completion Notes List
*To be filled by dev agent*

### File List
- App/Sources/Features/PatientRecords/Domain/Models/PatientId.swift
- App/Sources/Features/PatientRecords/Domain/Models/Species.swift
- App/Sources/Features/PatientRecords/Domain/Models/MedicalRecord.swift
- App/Sources/Features/PatientRecords/Domain/Models/Owner.swift
- App/Sources/Features/PatientRecords/Domain/Models/Patient.swift
- App/Sources/Features/PatientRecords/Domain/Validation/PatientValidator.swift
- App/Sources/Features/PatientRecords/Domain/Repositories/PatientRepository.swift
- App/Sources/Infrastructure/Persistence/Entities/PatientEntity.swift
- App/Sources/Infrastructure/Repositories/SwiftDataPatientRepository.swift
- App/Sources/Features/PatientRecords/Presentation/Components/PatientComponents.swift
- App/Sources/Features/PatientRecords/Presentation/ViewModels/PatientFormViewModel.swift
- App/Sources/Features/PatientRecords/Presentation/Views/PatientFormView.swift
- App/Sources/Services/PatientService.swift
- App/Sources/DependencyInjection/Container+Services.swift
- App/Sources/Features/PatientRecords/Public/PatientRecordsModuleInterface.swift
- App/Sources/Data/SampleDataProvider.swift

## QA Results

*This section will be populated by the QA Agent after story completion*